<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>석고보드 물량산출 이미지 공유</title>
    
    <!-- 카카오 SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        /* 공유 모달 */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .share-modal.show {
            display: flex;
        }
        
        .share-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .share-modal h3 {
            text-align: center;
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.3rem;
        }
        
        /* 이미지 미리보기 */
        .image-preview {
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            display: block;
        }
        
        /* 안내 메시지 */
        .info-message {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #856404;
            text-align: center;
        }
        
        /* 공유 버튼들 */
        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .share-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .kakao-btn {
            background: #FEE500;
            color: #000000;
        }
        
        .kakao-btn:hover {
            background: #FFEB3B;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(254, 229, 0, 0.4);
        }
        
        .download-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .cancel-btn {
            background: #e0e0e0;
            color: #666;
        }
        
        .cancel-btn:hover {
            background: #d0d0d0;
        }
        
        /* 토스트 메시지 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 4000;
            display: none;
            animation: fadeInOut 3s ease;
            max-width: 90%;
            text-align: center;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .toast.show {
            display: block;
        }
        
        /* 테스트 버튼 */
        .test-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 20px 0;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Canvas는 숨김 */
        #resultCanvas {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>

<h1>📊 석고보드 물량 산출</h1>
<p style="color: #666;">산출 결과를 이미지로 공유할 수 있습니다</p>
<button onclick="shareResult()" class="test-btn">🔗 공유하기</button>

<!-- Canvas 요소 (숨김) -->
<canvas id="resultCanvas"></canvas>

<script>
// ============================================
// 카카오 SDK 초기화
// ============================================
Kakao.init('fbae899fb0be422001174b09533e1918');
console.log('카카오 SDK 초기화:', Kakao.isInitialized());

// ============================================
// 테스트용 변수 (실제 코드에서는 실제 변수 사용)
// ============================================
let currentSiteName = '테스트 현장';
let currentLossRate = 0.1;

// 예시 데이터 (실제로는 walls 배열 사용)
const sampleData = {
    boards: [
        { type: '일반', size: '1200×2400', thickness: '9.5T', quantity: 100 },
        { type: '방화', size: '1200×2400', thickness: '12.5T', quantity: 50 },
        { type: '방수', size: '1200×2400', thickness: '12.5T', quantity: 30 }
    ],
    joists: [
        { name: '38×89 SPF', length: '2700mm', quantity: 150 },
        { name: '50×50 각재', length: '2700mm', quantity: 80 },
        { name: '40×60 각재', length: '2700mm', quantity: 45 }
    ]
};

// ============================================
// Canvas로 이미지 생성
// ============================================
function generateImage(data) {
    const canvas = document.getElementById('resultCanvas');
    const ctx = canvas.getContext('2d');
    
    // Canvas 크기 설정
    const width = 800;
    canvas.width = width;
    
    let y = 40;
    
    // 임시 높이 설정
    canvas.height = 800;
    
    // 배경색
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, canvas.height);
    
    // 헤더 배경
    const gradient = ctx.createLinearGradient(0, 0, width, 0);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(1, '#764ba2');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, 120);
    
    // 제목
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 32px Malgun Gothic, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('📊 석고보드 물량 산출', width / 2, y + 25);
    
    // 현장명
    ctx.font = 'bold 24px Malgun Gothic, sans-serif';
    ctx.fillText(currentSiteName || '석고보드 산출', width / 2, y + 60);
    
    y = 140;
    
    // 정보 박스
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(30, y, width - 60, 50);
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 2;
    ctx.strokeRect(30, y, width - 60, 50);
    
    ctx.fillStyle = '#333333';
    ctx.font = '16px Malgun Gothic, sans-serif';
    ctx.textAlign = 'left';
    const dateStr = new Date().toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    ctx.fillText(`작성일: ${dateStr}`, 50, y + 30);
    ctx.fillText(`로스율: ${Math.round(currentLossRate * 100)}%`, 550, y + 30);
    
    y += 80;
    
    // 석고보드 섹션
    ctx.fillStyle = '#667eea';
    ctx.font = 'bold 22px Malgun Gothic, sans-serif';
    ctx.fillText('■ 석고보드', 50, y);
    y += 35;
    
    // 테이블 헤더
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(30, y, width - 60, 40);
    ctx.strokeStyle = '#cccccc';
    ctx.strokeRect(30, y, width - 60, 40);
    
    ctx.fillStyle = '#333333';
    ctx.font = 'bold 16px Malgun Gothic, sans-serif';
    ctx.fillText('종류', 50, y + 25);
    ctx.fillText('규격', 250, y + 25);
    ctx.fillText('두께', 450, y + 25);
    ctx.fillText('수량', 620, y + 25);
    
    y += 40;
    
    // 석고보드 데이터
    ctx.font = '16px Malgun Gothic, sans-serif';
    data.boards.forEach((board, index) => {
        ctx.fillStyle = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
        ctx.fillRect(30, y, width - 60, 40);
        ctx.strokeStyle = '#e0e0e0';
        ctx.strokeRect(30, y, width - 60, 40);
        
        ctx.fillStyle = '#333333';
        ctx.fillText(board.type, 50, y + 25);
        ctx.fillText(board.size, 250, y + 25);
        ctx.fillText(board.thickness, 450, y + 25);
        ctx.fillText(`${board.quantity}장`, 620, y + 25);
        
        y += 40;
    });
    
    y += 20;
    
    // 목자재 섹션
    ctx.fillStyle = '#764ba2';
    ctx.font = 'bold 22px Malgun Gothic, sans-serif';
    ctx.fillText('■ 목자재/각재', 50, y);
    y += 35;
    
    // 테이블 헤더
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(30, y, width - 60, 40);
    ctx.strokeStyle = '#cccccc';
    ctx.strokeRect(30, y, width - 60, 40);
    
    ctx.fillStyle = '#333333';
    ctx.font = 'bold 16px Malgun Gothic, sans-serif';
    ctx.fillText('품명', 50, y + 25);
    ctx.fillText('길이', 400, y + 25);
    ctx.fillText('수량', 620, y + 25);
    
    y += 40;
    
    // 각재 데이터
    ctx.font = '16px Malgun Gothic, sans-serif';
    data.joists.forEach((joist, index) => {
        ctx.fillStyle = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
        ctx.fillRect(30, y, width - 60, 40);
        ctx.strokeStyle = '#e0e0e0';
        ctx.strokeRect(30, y, width - 60, 40);
        
        ctx.fillStyle = '#333333';
        ctx.fillText(joist.name, 50, y + 25);
        ctx.fillText(joist.length, 400, y + 25);
        ctx.fillText(`${joist.quantity}개`, 620, y + 25);
        
        y += 40;
    });
    
    // 최종 높이 조정
    canvas.height = y + 40;
    
    return new Promise((resolve) => {
        canvas.toBlob((blob) => {
            resolve(blob);
        }, 'image/png');
    });
}

// ============================================
// 텍스트 버전 생성
// ============================================
function generateSummaryText() {
    let text = `━━━━━━━━━━━━━━━━━━\n`;
    text += `📊 ${currentSiteName}\n`;
    text += `━━━━━━━━━━━━━━━━━━\n`;
    text += `작성일: ${new Date().toLocaleString('ko-KR')}\n`;
    text += `로스율: ${Math.round(currentLossRate * 100)}%\n\n`;
    
    text += `【석고보드】\n`;
    sampleData.boards.forEach(board => {
        text += `▪ ${board.type} ${board.size} ${board.thickness}\n`;
        text += `  → ${board.quantity}장\n`;
    });
    
    text += `\n【목자재/각재】\n`;
    sampleData.joists.forEach(joist => {
        text += `▪ ${joist.name} (${joist.length})\n`;
        text += `  → ${joist.quantity}개\n`;
    });
    
    text += `\n━━━━━━━━━━━━━━━━━━`;
    
    return text;
}

// ============================================
// 공유 모달 열기
// ============================================
async function shareResult() {
    // 로딩 표시
    const loadingModal = document.createElement('div');
    loadingModal.className = 'share-modal show';
    loadingModal.id = 'loadingModal';
    loadingModal.innerHTML = `
        <div class="share-modal-content">
            <div class="loading">
                <p style="font-size: 18px; margin: 0;">🎨 이미지 생성 중...</p>
            </div>
        </div>
    `;
    document.body.appendChild(loadingModal);
    
    // 이미지 생성
    const imageBlob = await generateImage(sampleData);
    const imageUrl = URL.createObjectURL(imageBlob);
    
    // 로딩 제거
    loadingModal.remove();
    
    // 모바일 여부 확인
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // 공유 모달
    const modal = document.createElement('div');
    modal.className = 'share-modal show';
    modal.id = 'shareModal';
    
    let infoHTML = '';
    if (isMobile) {
        infoHTML = `<div class="info-message">💡 이미지를 저장한 후 카카오톡에서 파일로 전송하세요</div>`;
    } else {
        infoHTML = `<div class="info-message">💡 PC에서는 텍스트를 카카오톡으로 전송하고,<br>이미지는 저장 후 파일로 전송하세요</div>`;
    }
    
    modal.innerHTML = `
        <div class="share-modal-content">
            <h3>📤 공유 방법 선택</h3>
            <div class="image-preview">
                <img src="${imageUrl}" alt="산출 결과">
            </div>
            ${infoHTML}
            <div class="share-buttons">
                <button class="share-btn kakao-btn" onclick="shareToKakaoText()">
                    💬 카카오톡으로 텍스트 전송
                </button>
                <button class="share-btn download-btn" onclick="downloadImage()">
                    💾 이미지 저장하기
                </button>
                <button class="share-btn cancel-btn" onclick="closeShareModal()">
                    취소
                </button>
            </div>
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeShareModal();
        }
    });
    
    document.body.appendChild(modal);
    
    window.currentImageBlob = imageBlob;
    window.currentImageUrl = imageUrl;
}

function closeShareModal() {
    const modal = document.getElementById('shareModal');
    if (modal) {
        modal.remove();
    }
    if (window.currentImageUrl) {
        URL.revokeObjectURL(window.currentImageUrl);
    }
}

// ============================================
// 카카오톡으로 텍스트 전송
// ============================================
function shareToKakaoText() {
    const summaryText = generateSummaryText();
    
    try {
        Kakao.Share.sendDefault({
            objectType: 'text',
            text: summaryText,
            link: {
                mobileWebUrl: window.location.href,
                webUrl: window.location.href,
            },
            buttons: [
                {
                    title: '웹에서 보기',
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
            ],
        });
        
        showToast('✅ 카카오톡 창이 열립니다!');
        
    } catch (error) {
        console.error('카카오톡 공유 실패:', error);
        showToast('❌ 카카오톡 공유 실패. 이미지를 저장해주세요.');
    }
}

// ============================================
// 이미지 다운로드
// ============================================
function downloadImage() {
    const imageUrl = window.currentImageUrl;
    
    if (!imageUrl) {
        showToast('이미지 생성 실패');
        return;
    }
    
    const link = document.createElement('a');
    const fileName = `석고보드_물량산출_${currentSiteName}_${new Date().getTime()}.png`;
    link.href = imageUrl;
    link.download = fileName;
    link.click();
    
    showToast('💾 이미지가 저장되었습니다!');
}

// ============================================
// 토스트 메시지
// ============================================
function showToast(message) {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        toast.id = 'toast';
        document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

</script>

</body>
</html>
